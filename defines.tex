
%%%% Doc type
\documentclass[a4paper,10.5pt]{article}

%%%% Packages
%%% Page
\usepackage{geometry} % size settings of page
\usepackage{indentfirst} % indent first line to fit CJK culture
\usepackage{lastpage} % get last page number to do like 'Page 2, Total 13'
\usepackage{setspace}
\usepackage{fancyhdr} % fancy styles of page, add complex header and footer
\usepackage[perpage]{footmisc} % reset footnote counter per page
\usepackage{background} % set background content to add a vertical line on the left

%%% Locale
\usepackage{xeCJK,fontspec} % CJK support and font setter
\usepackage{ruby} % after xeCJK

%%% Table & Graph
\usepackage{array}
\usepackage{longtable} % tables which can longer than page
\usepackage{makecell} % multiline in table
\usepackage{graphicx} % input pdf/eps images
\usepackage{caption}
%\usepackage{mpgraphics} % MetaPost image language

%%% Feature
\usepackage[hyphens]{url} % input url
\usepackage[strings]{underscore} % treat underling as common string
\usepackage{hyperref}
\usepackage{titlesec}
\usepackage{listings} % put source code into document
\usepackage{xcolor} % change color of lstlisting
\usepackage{cite} % multiple cite items
\usepackage{algorithm}
\usepackage{algorithmicx}
\usepackage{algpseudocode}
\usepackage{amsmath}

%%%% Settings
%%% Page
\geometry{left=3.68cm,right=2.68cm,top=2.54cm,bottom=2.54cm} % workspace(cm): height(24.62), width(14.64)
%\setlength{\parskip}{0.618em}
\setlength{\parindent}{2em}

\newsavebox{\pagehdrimage}
\sbox{\pagehdrimage}{\includegraphics[totalheight=1cm]{image/tongji-header.pdf}}
\fancypagestyle{title}
{
    \fancyhf{}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
}
\fancypagestyle{abstract}
{
    \fancyhf{}
    \pagenumbering{Roman}
    \renewcommand{\headrulewidth}{0.5pt}
    \renewcommand{\footrulewidth}{0pt}
    \fancyhead[L]{\usebox{\pagehdrimage}}
    \fancyhead[R]{\sffamily{毕业设计（论文）}}
    \fancyfoot[C]{\thepage}
}
\fancypagestyle{body}
{
    \fancyhf{}
    \pagenumbering{arabic}
    \renewcommand{\headrulewidth}{0.5pt}
    \renewcommand{\footrulewidth}{0.5pt}
    \fancyhead[L]{\usebox{\pagehdrimage}}
    \fancyhead[R]{\sffamily{毕业设计（论文）}}
    \fancyfoot[R]{\sffamily{共 \pageref{LastPage} 页／第 \thepage 页}}
}
\SetBgScale{1}
\SetBgAngle{0}
\SetBgColor{black}
\SetBgContents{\rule{.4pt}{20cm}}
\SetBgHshift{-9cm}

%%% Locale
\XeTeXlinebreaklocale "zh"
\XeTeXlinebreakskip = 0pt plus 1pt
\let\oldruby\ruby
\def\ruby#1#2{\oldruby{#1}{#2}\futurelet\next\addCJKglue}
\def\addCJKglue{\ifx\next\ruby \CJKglue \fi}

\setmainfont[AutoFakeSlant=0.382]{Source Serif Pro}
\setsansfont[AutoFakeSlant=0.382]{Source Sans Pro}
\setmonofont[AutoFakeSlant=0.382]{Source Code Pro}
\setCJKmainfont[AutoFakeSlant=0.382]{Source Han Serif SC}
\setCJKsansfont[AutoFakeSlant=0.382]{Source Han Sans SC}
\setCJKmonofont[AutoFakeSlant=0.382]{Source Han Sans HW SC}
\newcommand{\code}[1]{\texttt{#1}}
\renewcommand{\contentsname}{目录}
\renewcommand{\figurename}{图}
\renewcommand{\tablename}{表}
%\newCJKfontfamily\ryumin{A-OTF Ryumin Pr5 L-KL}
%\newCJKfontfamily\mingliu{PMingLiU}

%%% Table & Graph
\newcolumntype{S}{>{\arraybackslash}m{2cm}}
\newcolumntype{M}{>{\arraybackslash}m{3cm}}
\newcolumntype{L}{>{\arraybackslash}m{5cm}}
\newcolumntype{G}{>{\arraybackslash}m{7cm}}
\newcolumntype{B}{p{0.3\textwidth}}
\newcolumntype{T}{p{0.6\textwidth}}

%%% Format spec
\titleformat{\section}
    {\centering\Large\sffamily\bfseries\filcenter}
    {\textnormal{\arabic{section}.}}{0.5em}{}

\lstdefinelanguage{llvm}{
% https://github.com/pbos/master-thesis/blob/master/lstlisting-llvm.sty
  morecomment = [l]{;},
  morestring=[b]", 
  sensitive = true,
  classoffset=0,
  morekeywords={
  },
  classoffset=1, keywordstyle=\color[rgb]{0.228, 0.703, 0.718},
  morekeywords={
    % instructions
    % terminators
    ret, br, switch, indirectbr, invoke, resume, unreachable,
    % binary operations
    add, fadd, sub, fsub, mul, fmul, udiv, sdiv, fdiv, urem, srem, frem,
    % bitwise binary operations
    shl, lshr, ashr, and, or, xor,
    % vector operations
    extractelement, insertelement, shufflevector,
    % aggregate operations
    extractvalue, insertvalue,
    % memory access and addressing operations
    alloca, load, store, fence, cmpxchg, atomicrmw, getelementptr,
    % conversion operations
    trunc, zext, sext, fptrunc, fpext, fptoui, fptosi, uitofp, sitofp, ptrtoint,
    inttoptr, bitcast,
    % other operations
    icmp, fcmp, phi, select, call, va_arg, landingpad,
    % instruction arguments
    nuw, nsw, exact, acquire, release, acq_rel, seq_cst, singlethread, volatile,
    xchg, add, sub, and, nand, or, xor, max, min, umax, umin, to, eq, ne, ugt,
    uge, ult, ule, sgt, sge, slt, sle, false, oeq, ogt, oge, olt, ole, one, ort,
    ueq, ugt, uge, ult, ule, une, uno, true,  personality, catch, filter,
    cleanup, inbounds, unwind, label, align, tail, to,
    % I thought these shouldn't be the same color as %vars, moved from
    % lower-level keywords
    define, declare, global, constant,
    internal, external, private,
    linkonce, linkonce_odr, weak, weak_odr, appending,
    common, extern_weak,
    thread_local, dllimport, dllexport,
    hidden, protected, default,
    except, deplibs,
    volatile, fastcc, coldcc, cc, ccc,
    x86_stdcallcc, x86_fastcallcc,
    ptx_kernel, ptx_device,
    signext, zeroext, inreg, sret, nounwind, noreturn,
    nocapture, byval, nest, readnone, readonly, noalias, uwtable,
    inlinehint, noinline, alwaysinline, optsize, ssp, sspreq,
    noredzone, noimplicitfloat, naked, alignstack,
    module, asm, align, tail, to,
    addrspace, section, alias, sideeffect, c, gc,
    target, datalayout, triple,
    blockaddress
  },
  alsoletter={\%,.},
  keywordsprefix={\%},
}

\lstdefinestyle{lstllvm}
{
    language=llvm,
    basicstyle=\ttfamily,
    breaklines=true,
    frame=shadowbox,
    keywordstyle=\color{green!30!black},
    commentstyle=\color{white!40!black}\textit,
    numbers=left,
    numberstyle=\color{darkgray},
    stringstyle=\color{purple},
    identifierstyle=\color{red!30!black},
    showstringspaces=false
    morekeywords=
    {
    }
}
\lstdefinestyle{lstcpp}
{
    language=C++,
    basicstyle=\ttfamily,
    breaklines=true,
    frame=shadowbox,
    keywordstyle=\color{green!30!black},
    commentstyle=\color{white!40!black}\textit,
    numbers=left,
    numberstyle=\color{darkgray},
    stringstyle=\color{purple},
    identifierstyle=\color{red!30!black},
    showstringspaces=false
    morekeywords=
    {
        mxArray,
        MATFile,
        mat_t,
        matvar_t,
        GLuint,
        GLint,
        GLfloat,
        EGLContext,
        EGLSurface,
        EGLint,
        EGLConfig,
        EGLDisplay,
    }
}
\lstdefinestyle{lstmake}
{
    language=make,
    basicstyle=\ttfamily,
    breaklines=true,
    frame=shadowbox,
    keywordstyle=\color{green!30!black},
    commentstyle=\color{white!40!black}\textit,
    numbers=left,
    numberstyle=\color{darkgray},
    stringstyle=\color{purple},
    identifierstyle=\color{red!30!black},
    showstringspaces=false
}\lstdefinestyle{lstbash}
{
    language=bash,
    basicstyle=\ttfamily,
    breaklines=true,
    frame=shadowbox,
    keywordstyle=\color{green!30!black},
    commentstyle=\color{white!40!black}\textit,
    numbers=left,
    numberstyle=\color{darkgray},
    stringstyle=\color{purple},
    identifierstyle=\color{red!30!black},
    showstringspaces=false
}
\lstdefinestyle{lstnone}{
  identifierstyle=
}

\lstset{style=lstcpp}

\floatname{algorithm}{算法}
\renewcommand{\algorithmicrequire}{\textbf{输入:}}
\renewcommand{\algorithmicensure}{\textbf{输出:}}

%%% hyperref
\hypersetup
{
    colorlinks,
    linkcolor={magenta!80!black},
    citecolor={cyan!80!black},
    urlcolor={blue!80!black},
}

